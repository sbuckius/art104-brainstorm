<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Collaborative Brainstorming</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { font-family: Arial; max-width: 1000px; margin:auto; padding:20px; background:#f5f5f5; }
h1,h2 { color:#333; }
input, select, button, textarea { font-size:1rem; padding:8px; margin:5px 0; }
textarea { resize: vertical; min-height:60px; width: 100%; box-sizing: border-box; }
#groupPage { display:none; }
.step { background:#fff; padding:15px; margin:15px 0; border-radius:8px; border-left:6px solid #4CAF50; }
.step-title { font-weight: bold; font-size: 1.1em; margin-bottom: 10px; }
.responses { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:15px; margin-top:10px; }
.response-box { border: 2px solid #ddd; border-radius: 5px; padding: 10px; }
.user-label { font-weight:bold; padding:5px; border-radius:3px; color:white; margin-bottom: 5px; }
.avatar { display:inline-block; padding:8px 12px; margin:3px; border-radius:5px; color:white; font-weight:bold; }
.leader { border:3px solid gold; }
#resetBtn { background: #f44336; color: white; margin-left: 10px; }
</style>
</head>
<body>

<div id="lobbyPage">
<h1>üß† Brainstorm Lobby</h1>
<p>Enter your avatar name:</p>
<input type="text" id="avatarName" placeholder="Your Name">
<p>Select group (1‚Äì10):</p>
<select id="groupSelect">
  <option value="">-- Choose a group --</option>
  <option value="1">Group 1</option>
  <option value="2">Group 2</option>
  <option value="3">Group 3</option>
  <option value="4">Group 4</option>
  <option value="5">Group 5</option>
  <option value="6">Group 6</option>
  <option value="7">Group 7</option>
  <option value="8">Group 8</option>
  <option value="9">Group 9</option>
  <option value="10">Group 10</option>
</select>
<br><br>
<button id="joinGroupBtn">Join Group</button>
</div>

<div id="groupPage">
<h1 id="groupTitle"></h1>
<div id="avatars"></div>
<div id="processSelectionDiv" style="margin:15px 0;"></div>
<button id="exportBtn">üìÑ Export PDF</button>
<button id="resetBtn">üóëÔ∏è Reset & Start Over</button>
<div id="processSteps" style="margin-top: 20px;"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBEn-_qOw_6k-v6qjHvSfthNJwvUwdzEI0",
  authDomain: "art104-brainstorm-space.firebaseapp.com",
  projectId: "art104-brainstorm-space",
  storageBucket: "art104-brainstorm-space.firebasestorage.app",
  messagingSenderId: "809793310505",
  appId: "1:809793310505:web:8bd39b8eb465c784f67138",
  measurementId: "G-LND87XNSBT"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const userColors = ["#FF6F61","#6B5B95","#88B04B","#F7CAC9"];
let username = "";
let groupNum = "";
let currentDocRef = null;
let isLeader = false;
let unsubscribe = null;

const processes = {
  prosCons: ["List your favorite sketches", "List strengths of these sketches", "Write pros/cons of these sketches", "Select the strongest ideas", "Describe refinements to the top ideas.","Summarize the best refined idea."],
  mergeIdeas: ["List all sketches", "Pick parts of the ideas to combine.", "Describe the combined ideas and how they go together.", "Describe refinements to the combined idea.", "Adjust the final idea and describe the outcome."],
  ranking: ["List criteria that you think should be included in the project.", "Rank the sketches", "Select the Top 3 ideas.", "Eliminate the weak parts of these ideas.", "Finalize the details of the best idea."],
  peerFeedback: ["Present sketches.", "Collect feedback from someone about the sketches.", "Find common themes in the feedback.", "Choose the best ideas based on the feedback.", "Refine the best idea."],
  storytelling: ["Create a short narrative.", "Evaluate the clarity and creativity of the story.", "Check alignment with other group members' ideas.", "Choose the strongest elements of one or more than one story.", "Refine the story."],
  collectiveConcept: ["Each group member contributes a phrase", "Combine parts of all contributions", "Find interesting connections", "Write the final combined sentence with the best parts of the phrases."],
  sillyMashup: ["Each group member contributes a phrase", "Each group member contributes another phrase", "Each group member contributes another phrase", "Combine all phrases."],
  technologyMashup: ["Each group member contributes a phrase about technology", "Each group member contributes another phrase about technology", "Each group member contributes another phrase about technology", "Combine all phrases and find a concept."],
};

// JOIN GROUP
document.getElementById("joinGroupBtn").addEventListener("click", async () => {
  username = document.getElementById("avatarName").value.trim();
  groupNum = document.getElementById("groupSelect").value;
  
  if(!username || !groupNum) {
    alert("Please enter your name and select a group!");
    return;
  }

  currentDocRef = doc(db, "groups", `group_${groupNum}`);
  const snap = await getDoc(currentDocRef);
  
  if(!snap.exists()) {
    // Create new group
    await setDoc(currentDocRef, {
      members: [{name: username, color: userColors[0], leader: true}],
      processName: "",
      steps: []
    });
    isLeader = true;
  } else {
    // Join existing group
    const data = snap.data();
    const existingMember = data.members.find(m => m.name === username);
    
    if(existingMember) {
      isLeader = existingMember.leader;
    } else {
      if(data.members.length >= 4) {
        alert("Group is full (max 4 members)!");
        return;
      }
      const newMembers = [...data.members, {
        name: username,
        color: userColors[data.members.length],
        leader: false
      }];
      await setDoc(currentDocRef, {...data, members: newMembers});
      isLeader = false;
    }
  }
  
  document.getElementById("lobbyPage").style.display = "none";
  document.getElementById("groupPage").style.display = "block";
  document.getElementById("groupTitle").textContent = `Group ${groupNum}`;
  
  startListening();
});

// RESET GROUP
document.getElementById("resetBtn").addEventListener("click", async () => {
  if(!currentDocRef) return;
  
  if(confirm("‚ö†Ô∏è Delete ALL group data and start fresh?")) {
    if(unsubscribe) unsubscribe();
    await deleteDoc(currentDocRef);
    location.reload();
  }
});

// LISTEN TO CHANGES
function startListening() {
  unsubscribe = onSnapshot(currentDocRef, (snap) => {
    if(!snap.exists()) return;
    
    const data = snap.data();
    updateUI(data);
  });
}

// UPDATE UI
function updateUI(data) {
  // Show members
  const avatarsDiv = document.getElementById("avatars");
  avatarsDiv.innerHTML = "";
  data.members.forEach(m => {
    const span = document.createElement("span");
    span.className = "avatar";
    if(m.leader) span.classList.add("leader");
    span.style.backgroundColor = m.color;
    span.textContent = m.name + (m.leader ? " üëë" : "");
    avatarsDiv.appendChild(span);
  });
  
  // Process selection (leader only)
  const processDiv = document.getElementById("processSelectionDiv");
  
  if(isLeader && !data.processName) {
    processDiv.innerHTML = `
      <strong>Choose a process:</strong><br>
      <select id="processSelect" style="margin: 5px 0;">
        <option value="">-- Select Process --</option>
        ${Object.keys(processes).map(k => `<option value="${k}">${k}</option>`).join('')}
      </select>
      <button id="startBtn">‚ñ∂Ô∏è Start</button>
    `;
    
    document.getElementById("startBtn").addEventListener("click", async () => {
      const selected = document.getElementById("processSelect").value;
      if(!selected) {
        alert("Please select a process first!");
        return;
      }
      
      const steps = processes[selected].map(text => {
        const responses = {};
        data.members.forEach(m => {
          responses[m.name] = "";
        });
        return { text, responses };
      });
      
      await setDoc(currentDocRef, {
        ...data,
        processName: selected,
        steps: steps
      });
    });
  } else if(data.processName) {
    processDiv.innerHTML = `<strong>Process:</strong> ${data.processName}`;
    renderSteps(data);
  } else {
    processDiv.innerHTML = "‚è≥ Waiting for leader to select a process...";
  }
}

// RENDER STEPS
function renderSteps(data) {
  const stepsDiv = document.getElementById("processSteps");
  stepsDiv.innerHTML = "";
  
  if(!data.steps || !Array.isArray(data.steps)) {
    stepsDiv.innerHTML = '<p style="color:red; padding:20px; background:white; border-radius:8px;">‚ùå Data error. Click "Reset & Start Over".</p>';
    return;
  }
  
  data.steps.forEach((step, stepIdx) => {
    const stepDiv = document.createElement("div");
    stepDiv.className = "step";
    
    const titleDiv = document.createElement("div");
    titleDiv.className = "step-title";
    titleDiv.textContent = `${stepIdx + 1}. ${step.text}`;
    stepDiv.appendChild(titleDiv);
    
    const responsesDiv = document.createElement("div");
    responsesDiv.className = "responses";
    
    data.members.forEach(member => {
      const box = document.createElement("div");
      box.className = "response-box";
      
      const label = document.createElement("div");
      label.className = "user-label";
      label.style.backgroundColor = member.color;
      label.textContent = member.name;
      box.appendChild(label);
      
      const textarea = document.createElement("textarea");
      textarea.value = step.responses[member.name] || "";
      textarea.placeholder = member.name === username ? "Type here..." : "";
      
      if(member.name === username) {
        textarea.style.border = `2px solid ${member.color}`;
        textarea.style.backgroundColor = "#fff";
        
        // Save on blur (when user clicks away)
        textarea.addEventListener("blur", async () => {
          const newData = {...data};
          newData.steps[stepIdx].responses[member.name] = textarea.value;
          await setDoc(currentDocRef, newData);
        });
      } else {
        textarea.disabled = true;
        textarea.style.backgroundColor = "#f5f5f5";
      }
      
      box.appendChild(textarea);
      responsesDiv.appendChild(box);
    });
    
    stepDiv.appendChild(responsesDiv);
    stepsDiv.appendChild(stepDiv);
  });
}

// EXPORT PDF
document.getElementById("exportBtn").addEventListener("click", async () => {
  if(!currentDocRef) return;
  
  const snap = await getDoc(currentDocRef);
  if(!snap.exists()) {
    alert("No data found!");
    return;
  }
  
  const data = snap.data();
  
  if(!data.processName || !data.steps || !Array.isArray(data.steps)) {
    alert("No process started yet!");
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y = 20;
  
  pdf.setFontSize(18);
  pdf.setFont(undefined, 'bold');
  pdf.text(`Group ${groupNum} - ${data.processName}`, 20, y);
  y += 15;
  
  data.steps.forEach((step, idx) => {
    if(y > 260) {
      pdf.addPage();
      y = 20;
    }
    
    pdf.setFontSize(14);
    pdf.setFont(undefined, 'bold');
    pdf.text(`${idx + 1}. ${step.text}`, 20, y);
    y += 10;
    
    pdf.setFontSize(11);
    pdf.setFont(undefined, 'normal');
    
    data.members.forEach(member => {
      const response = step.responses[member.name];
      if(response && response.trim()) {
        const lines = pdf.splitTextToSize(`${member.name}: ${response}`, 170);
        
        if(y + lines.length * 6 > 280) {
          pdf.addPage();
          y = 20;
        }
        
        pdf.text(lines, 25, y);
        y += lines.length * 6 + 3;
      }
    });
    
    y += 8;
  });
  
  pdf.save(`Group${groupNum}_${data.processName}.pdf`);
});
</script>
</body>
</html>
